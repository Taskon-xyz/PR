digraph OnchainProcess {
    rankdir=TB;
    compound=true;
    fontname="Arial";
    fontsize=10;
    newrank=true; // Enforce stricter ranking for clusters

    // Layout optimizations
    splines=ortho;
    concentrate=true;
    nodesep=0.5;
    ranksep=1.0;

    node [fontname="Arial", fontsize=10, fontcolor=black, style=filled, shape=box, fillcolor="white", color="dimgray"];
    edge [fontname="Arial", fontsize=9, color="dimgray"];

    // C端用户
    subgraph cluster_C_User {
        label="C端用户"; labelloc="t"; fontsize=18; fontcolor=black;
        style=filled; bgcolor="azure";
        pencolor="dimgray";

        C_Start [label="开始", shape=doublecircle, fillcolor="palegreen"];
        C_SeeRecommend [label="看到推荐/任务"];
        C_Click [label="点击跳转"];
        C_DoAction [label="完成Action/Task"];
        C_GetReward [label="获得奖励"];
        C_End [label="结束", shape=doublecircle, fillcolor="lightcoral"];

        C_Start -> C_SeeRecommend;
        C_SeeRecommend -> C_Click;
        C_Click -> C_DoAction;
        C_DoAction -> C_GetReward;
        C_GetReward -> C_End;
    }

    // B端用户
    subgraph cluster_B_User {
        label="B端用户"; labelloc="t"; fontsize=18; fontcolor=black;
        style=filled; bgcolor="honeydew";
        pencolor="dimgray";

        B_Start [label="开始", shape=doublecircle, fillcolor="palegreen"];
        B_SeeEntry [label="看到 Onchain Boost 入口"];
        B_CreateTask [label="创建 Onchain Task (Deposit Token)"];
        B_ViewData [label="实时查看完成人数"];
        B_End [label="结束 (查看数据)", shape=doublecircle, fillcolor="lightcoral"];
        B_ReceiveRefund [label="收到退款"];
        B_End2 [label="结束 (退款)", shape=doublecircle, fillcolor="lightcoral"];

        B_Start -> B_SeeEntry;
        B_SeeEntry -> B_CreateTask;
        B_CreateTask -> B_ViewData;
        B_ViewData -> B_End;
        B_ReceiveRefund -> B_End2;
    }

    // 运营后台
    subgraph cluster_Ops {
        label="运营后台"; labelloc="t"; fontsize=18; fontcolor=black;
        style=filled; bgcolor="seashell";
        pencolor="dimgray";
        O_Start [label="开始", shape=doublecircle, fillcolor="palegreen"];

        subgraph cluster_Ops_ActionPush {
            label="自有Action推送"; labelloc="t"; fontsize=14; fontcolor=black;
            style=filled; bgcolor="floralwhite";
            pencolor="darkgray";

            O_CreateAction [label="创建Action"];
            O_SetTarget [label="设置推荐目标用户"];
            O_PushToC [label="推送给目标C端用户"];
            O_SubmitApprovalAction [label="提交审批"];
            O_ActionOnline [label="Action出现在新板块"];
            O_EndActionFlow [label="结束 (Action推送)", shape=doublecircle, fillcolor="lightcoral"];
            O_ViewDataAction [label="查看Action完成数据"];
            O_EndActionFlow2 [label="结束 (Action数据查看)", shape=doublecircle, fillcolor="lightcoral"];

            O_CreateAction -> O_SetTarget;
            O_CreateAction -> O_SubmitApprovalAction;
            O_SetTarget -> O_PushToC;
            O_ActionOnline -> O_PushToC;
            O_ViewDataAction -> O_EndActionFlow2;
        }

        subgraph cluster_Ops_BTaskMgmt {
            label="B端Task管理"; labelloc="t"; fontsize=14; fontcolor=black;
            style=filled; bgcolor="floralwhite";
            pencolor="darkgray";

            O_SeeTaskList [label="看到投放列表"];
            O_JudgeContract_condition [label="是否涉及新合约?", shape=diamond, fillcolor="lightblue"];
            O_SubmitContractApproval [label="提交合约审核 Donald"];
            O_AcceptTask [label="接受Task"];
            O_RejectTask [label="拒绝Task"];
            O_JudgeTaskReasonable_condition [label="Task是否合理/可完成?", shape=diamond, fillcolor="lightblue"];
            O_SubmitAcceptApproval [label="提交接受审批"];
            O_TaskOnline [label="Task出现在新板块"];
            O_PushToC2 [label="推送给C端用户 (Task)"];
            O_EndTaskFlow [label="结束 (Task接受流程)", shape=doublecircle, fillcolor="lightcoral"];
            O_SubmitRejectApproval [label="提交拒绝审批"];
            O_AutoRefund [label="自动退款给B端"];
            O_EndTaskFlow5 [label="结束 (自动退款)", shape=doublecircle, fillcolor="lightcoral"];
            O_EndTaskFlow2 [label="结束 (Task拒绝流程)", shape=doublecircle, fillcolor="lightcoral"];
            O_ViewDataTask [label="实时查看Task完成人数"];
            O_CheckCompletion_condition [label="是否到期未完成?", shape=diamond, fillcolor="lightblue"];
            O_ManualRefund [label="手动退款流程"];
            O_EndTaskFlow4 [label="结束 (手动退款)", shape=doublecircle, fillcolor="lightcoral"];
            O_EndTaskFlow3 [label="结束 (Task未到期)", shape=doublecircle, fillcolor="lightcoral"];

            O_SeeTaskList -> O_JudgeContract_condition;
            O_JudgeContract_condition -> O_SubmitContractApproval [label="是"];
            O_JudgeContract_condition -> O_JudgeTaskReasonable_condition [label="否"];
            O_JudgeTaskReasonable_condition -> O_AcceptTask [label="是"];
            O_JudgeTaskReasonable_condition -> O_RejectTask [label="否"];

            O_AcceptTask -> O_SubmitAcceptApproval;
            O_TaskOnline -> O_PushToC2;

            O_RejectTask -> O_SubmitRejectApproval;
            O_AutoRefund -> O_EndTaskFlow5;

            O_ViewDataTask -> O_CheckCompletion_condition;
            O_CheckCompletion_condition -> O_ManualRefund [label="是"];
            O_CheckCompletion_condition -> O_EndTaskFlow3 [label="否"];
            O_ManualRefund -> O_EndTaskFlow4;
        }
        O_Start -> O_CreateAction;
        O_Start -> O_SeeTaskList;
    }

    // 系统/合约
    subgraph cluster_System {
        label="系统/合约"; labelloc="t"; fontsize=18; fontcolor=black;
        style=filled; bgcolor="ivory";
        pencolor="dimgray";
        S_Start [label="开始", shape=doublecircle, fillcolor="palegreen"];
        S_VerifyAction [label="验证Action/Task完成"];
        S_SendReward [label="发放奖励"];

        S_Start -> S_VerifyAction;
        S_VerifyAction -> S_SendReward;

        subgraph cluster_System_ApprovalNodes {
            label="审批节点"; labelloc="t"; fontsize=14; fontcolor=black;
            style=filled; bgcolor="lightyellow";
            pencolor="darkgray";

            Approval_Action_System_Trigger [label="触发：审批自有Action"];
            Donald_Approve_System_Trigger [label="触发：Donald审批新合约"];
            Approval_Accept_System_Trigger [label="触发：审批运营接受"];
            Approval_Reject_System_Trigger [label="触发：审批运营拒绝"];

            Approval_Action [label="审批自有Action?", shape=diamond, fillcolor="lightblue"];
            Donald_Approve [label="Donald审批新合约?", shape=diamond, fillcolor="lightblue"];
            Approval_Accept [label="审批运营接受?", shape=diamond, fillcolor="lightblue"];
            Approval_Reject [label="审批运营拒绝?", shape=diamond, fillcolor="lightblue"];

            O_EndActionFlow_By_Action [label="系统记录：Action审批拒绝"];
            O_RejectTask_By_Contract [label="系统记录：合约拒绝"];
            O_EndTaskFlow_By_Accept [label="系统记录：接受审批拒绝"];
            O_EndTaskFlow_By_Reject [label="系统记录：拒绝审批拒绝"];

            Approval_Action_System_Trigger -> Approval_Action;
            Donald_Approve_System_Trigger -> Donald_Approve;
            Approval_Accept_System_Trigger -> Approval_Accept;
            Approval_Reject_System_Trigger -> Approval_Reject;

            Approval_Action -> O_ActionOnline [label="是", lhead=cluster_Ops_ActionPush];
            Approval_Action -> O_EndActionFlow_By_Action [label="否"];
            O_EndActionFlow_By_Action -> O_EndActionFlow [lhead=cluster_Ops_ActionPush];

            Donald_Approve -> O_AcceptTask [label="是", lhead=cluster_Ops_BTaskMgmt];
            Donald_Approve -> O_RejectTask_By_Contract [label="否"];
            O_RejectTask_By_Contract -> O_RejectTask [lhead=cluster_Ops_BTaskMgmt];

            Approval_Accept -> O_TaskOnline [label="是", lhead=cluster_Ops_BTaskMgmt];
            Approval_Accept -> O_EndTaskFlow_By_Accept [label="否"];
            O_EndTaskFlow_By_Accept -> O_EndTaskFlow [lhead=cluster_Ops_BTaskMgmt];

            Approval_Reject -> O_AutoRefund [label="是", lhead=cluster_Ops_BTaskMgmt];
            Approval_Reject -> O_EndTaskFlow_By_Reject [label="否"];
            O_EndTaskFlow_By_Reject -> O_EndTaskFlow2 [lhead=cluster_Ops_BTaskMgmt];
        }
    }

    // Inter-Cluster Edges
    O_PushToC -> C_SeeRecommend;
    O_PushToC2 -> C_SeeRecommend;
    S_SendReward -> C_GetReward;
    O_AutoRefund -> B_ReceiveRefund;
    O_ManualRefund -> B_ReceiveRefund;
    C_DoAction -> O_ViewDataAction;
    C_DoAction -> O_ViewDataTask;
    C_DoAction -> S_VerifyAction;
    B_CreateTask -> O_SeeTaskList;
    B_ViewData -> O_ViewDataTask;
    O_SubmitApprovalAction -> Approval_Action_System_Trigger;
    O_SubmitContractApproval -> Donald_Approve_System_Trigger;
    O_SubmitAcceptApproval -> Approval_Accept_System_Trigger;
    O_SubmitRejectApproval -> Approval_Reject_System_Trigger;
}